image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - report
  - monitoring
  - deploy

services:
  - name: selenium/standalone-chrome:latest
    alias: selenium-standalone

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."

dotnet-test:
  stage: test
  script:
    - dotnet restore
    - dotnet test StepikTesting.sln --logger "trx" --results-directory TestResults
  artifacts:
    when: always
    reports:
      junit:
        - TestResults/*.trx
    paths:
      - TestResults/
    expire_in: 1 week
  allow_failure: true

allure-report:
  image: openjdk:11-jdk
  stage: report
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
    - unzip allure-2.21.0.zip -d /opt/
    - ln -s /opt/allure-2.21.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate TestResults --clean -o allure-report
    - |
      mkdir -p allure-report/data
      cat > allure-report/data/environment.json << EOF
      {
        "allure": {
          "directory": "allure-results",
          "links": [],
          "environment": {
            "runtime": "net8.0",
            "allure_version": "2.21.0",
            "specflow_version": "3.9.74"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  dependencies:
    - dotnet-test

grafana-monitoring:
  image: docker:latest
  stage: monitoring
  services:
    - docker:dind
  before_script:
    - apk add --no-cache docker-compose curl jq
  script:
    - echo "Starting monitoring stack..."
    - docker-compose -f docker-compose.yml up -d
    - echo "Waiting for services to become healthy..."
    - sleep 30
    - echo "Checking internal service connectivity via container names..."
    - |
      # Check services using container names instead of service names
      PROMETHEUS_CONTAINER=$(docker ps --filter "name=prometheus" --format "{{.Names}}")
      GRAFANA_CONTAINER=$(docker ps --filter "name=grafana" --format "{{.Names}}")
      
      echo "Found containers: Prometheus=$PROMETHEUS_CONTAINER, Grafana=$GRAFANA_CONTAINER"
    - echo "Checking Prometheus health via container network..."
    - |
      # Use Docker container IP instead of service name
      PROMETHEUS_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -q --filter "name=prometheus"))
      if [ -n "$PROMETHEUS_IP" ] && curl -s --connect-timeout 10 http://${PROMETHEUS_IP}:9090/-/ready > /dev/null; then
        echo "✓ Prometheus is healthy and accessible internally at ${PROMETHEUS_IP}:9090."
      else
        echo "✗ Prometheus is not accessible internally."
        # Try alternative approach using localhost with mapped port
        PROMETHEUS_PORT=$(docker-compose -f docker-compose.yml port prometheus 9090 2>/dev/null | cut -d: -f2)
        if [ -n "$PROMETHEUS_PORT" ] && curl -s --connect-timeout 10 http://localhost:${PROMETHEUS_PORT}/-/ready > /dev/null; then
          echo "✓ Prometheus is accessible via localhost:${PROMETHEUS_PORT}."
        else
          echo "✗ Prometheus health check failed completely."
          exit 1
        fi
      fi
    - echo "Checking Grafana health via container network..."
    - |
      # Use Docker container IP instead of service name
      GRAFANA_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -q --filter "name=grafana"))
      if [ -n "$GRAFANA_IP" ] && curl -s --connect-timeout 10 http://${GRAFANA_IP}:3000/api/health > /dev/null; then
        echo "✓ Grafana is healthy and accessible internally at ${GRAFANA_IP}:3000."
      else
        echo "✗ Grafana is not accessible internally."
        # Try alternative approach using localhost with mapped port
        GRAFANA_PORT=$(docker-compose -f docker-compose.yml port grafana 3000 2>/dev/null | cut -d: -f2)
        if [ -n "$GRAFANA_PORT" ] && curl -s --connect-timeout 10 http://localhost:${GRAFANA_PORT}/api/health > /dev/null; then
          echo "✓ Grafana is accessible via localhost:${GRAFANA_PORT}."
        else
          echo "✗ Grafana health check failed completely."
          exit 1
        fi
      fi
    - echo "Checking external accessibility..."
    - |
      # Get the actual mapped ports for external access
      PROMETHEUS_PORT=$(docker-compose -f docker-compose.yml port prometheus 9090 2>/dev/null | cut -d: -f2)
      GRAFANA_PORT=$(docker-compose -f docker-compose.yml port grafana 3000 2>/dev/null | cut -d: -f2)
      
      echo "Mapped ports - Prometheus: ${PROMETHEUS_PORT:-not found}, Grafana: ${GRAFANA_PORT:-not found}"
    - echo "Checking Prometheus accessibility on host network..."
    - |
      if [ -n "$PROMETHEUS_PORT" ] && curl -s --connect-timeout 10 http://localhost:${PROMETHEUS_PORT}/-/ready > /dev/null; then
        echo "✓ Prometheus is accessible externally on localhost:${PROMETHEUS_PORT}."
      else
        echo "✗ Prometheus is not accessible externally."
        exit 1
      fi
    - echo "Checking Grafana accessibility on host network..."
    - |
      if [ -n "$GRAFANA_PORT" ] && curl -s --connect-timeout 10 http://localhost:${GRAFANA_PORT}/api/health > /dev/null; then
        echo "✓ Grafana is accessible externally on localhost:${GRAFANA_PORT}."
      else
        echo "✗ Grafana is not accessible externally."
        exit 1
      fi
    - echo "All monitoring services are healthy and accessible!"
  when: manual
  allow_failure: false
  timeout: 20 minutes

deploy-job:
  stage: deploy
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
