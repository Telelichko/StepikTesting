image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - report
  - monitoring
  - deploy

services:
  - name: selenium/standalone-chrome:latest
    alias: selenium-standalone

variables:
  PROMETHEUS_URL: "http://prometheus:9090/"
  GRAFANA_URL: "http://grafana:3000/"

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."

dotnet-test:
  stage: test
  script:
    - dotnet restore
    - dotnet test StepikTesting.sln --logger "trx" --results-directory TestResults
  artifacts:
    when: always
    reports:
      junit:
        - TestResults/*.trx
    paths:
      - TestResults/
    expire_in: 1 week
  allow_failure: true

allure-report:
  image: openjdk:11-jdk
  stage: report
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
    - unzip allure-2.21.0.zip -d /opt/
    - ln -s /opt/allure-2.21.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate TestResults --clean -o allure-report
    - |
      mkdir -p allure-report/data
      cat > allure-report/data/environment.json << EOF
      {
        "allure": {
          "directory": "allure-results",
          "links": [],
          "environment": {
            "runtime": "net8.0",
            "allure_version": "2.21.0",
            "specflow_version": "3.9.74"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  dependencies:
    - dotnet-test

grafana-monitoring:
  stage: monitoring
  image: appropriate/curl:latest
  services:
    - name: prom/prometheus:latest
      alias: prometheus
    - name: grafana/grafana:latest
      alias: grafana
  before_script:
    - |
      echo "Waiting for monitoring services to be ready..."
      # Wait for Prometheus to be ready
      for i in {1..30}; do
        if curl -s --head --request GET "$PROMETHEUS_URL" | grep "200\|302" > /dev/null; then
          echo "Prometheus is ready!"
          break
        fi
        echo "Waiting for Prometheus... ($i/30)"
        sleep 5
      done
      
      # Wait for Grafana to be ready
      for i in {1..30}; do
        if curl -s --head --request GET "$GRAFANA_URL" | grep "200\|302" > /dev/null; then
          echo "Grafana is ready!"
          break
        fi
        echo "Waiting for Grafana... ($i/30)"
        sleep 5
      done
  script:
    - |
      echo "=== Monitoring Setup ==="
      
      echo "Using service URLs for monitoring:"
      echo "Prometheus URL: $PROMETHEUS_URL"
      echo "Grafana URL: $GRAFANA_URL"
      
      # Test if URLs are accessible using service names
      echo "Testing Prometheus connectivity..."
      if curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\n" "$PROMETHEUS_URL"; then
        echo "✓ Prometheus is accessible via service URL"
      else
        echo "✗ Prometheus is not accessible via service URL"
      fi
      
      echo "Testing Grafana connectivity..."
      if curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\n" "$GRAFANA_URL"; then
        echo "✓ Grafana is accessible via service URL"
      else
        echo "✗ Grafana is not accessible via service URL"
      fi
      
      # Test additional endpoints
      echo "Testing Prometheus graph endpoint..."
      curl -f -s -o /dev/null -w "Prometheus Graph HTTP Status: %{http_code}\n" "${PROMETHEUS_URL}graph" || echo "Prometheus graph endpoint not accessible"
      
      echo "Testing Grafana API endpoint..."
      curl -f -s -o /dev/null -w "Grafana API HTTP Status: %{http_code}\n" "${GRAFANA_URL}api/health" || echo "Grafana API endpoint not accessible"
      
      # Basic setup for Grafana using service URLs
      echo "Setting up Grafana datasource..."
      curl -X POST "${GRAFANA_URL}api/datasources" \
        -H "Content-Type: application/json" \
        -d '{
          "name": "Prometheus",
          "type": "prometheus",
          "url": "'"$PROMETHEUS_URL"'",
          "access": "proxy",
          "basicAuth": false
        }' || echo "Note: Datasource setup might require authentication"
      
      # Create monitoring.env file with service URLs
      cat > monitoring.env << EOF
      PROMETHEUS_URL=$PROMETHEUS_URL
      GRAFANA_URL=$GRAFANA_URL
      PROMETHEUS_GRAPH_URL=${PROMETHEUS_URL}graph
      PROMETHEUS_TARGETS_URL=${PROMETHEUS_URL}targets
      GRAFANA_API_URL=${GRAFANA_URL}api
      GRAFANA_DATASOURCES_URL=${GRAFANA_URL}datasources
      EOF
      
      echo "Monitoring URLs saved:"
      cat monitoring.env
      
      echo "Monitoring setup completed!"
      
      # Wait for manual testing (5 minutes)
      echo "Waiting 5 minutes for manual testing and monitoring verification..."
      sleep 300
      
      echo "Manual testing period completed."
  artifacts:
    reports:
      dotenv: monitoring.env
    paths:
      - monitoring.env
    expire_in: 1 week
  when: manual
  allow_failure: false
  timeout: 20 minutes

deploy-job:
  stage: deploy
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
