image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - report
  - monitoring
  - deploy

services:
  - name: selenium/standalone-chrome:latest
    alias: selenium-standalone

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."

dotnet-test:
  stage: test
  script:
    - dotnet restore
    - dotnet test StepikTesting.sln --logger "trx" --results-directory TestResults
  artifacts:
    when: always
    reports:
      junit:
        - TestResults/*.trx
    paths:
      - TestResults/
    expire_in: 1 week
  allow_failure: true

allure-report:
  image: openjdk:11-jdk
  stage: report
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
    - unzip allure-2.21.0.zip -d /opt/
    - ln -s /opt/allure-2.21.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate TestResults --clean -o allure-report
    - |
      mkdir -p allure-report/data
      cat > allure-report/data/environment.json << EOF
      {
        "allure": {
          "directory": "allure-results",
          "links": [],
          "environment": {
            "runtime": "net8.0",
            "allure_version": "2.21.0",
            "specflow_version": "3.9.74"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  dependencies:
    - dotnet-test

monitoring:
  image: docker:latest
  stage: monitoring
  services:
    - docker:dind
  before_script:
    - apk add --no-cache docker-compose curl jq
  script:
    - |
      # Start docker-compose
      echo "Starting monitoring stack..."
      docker-compose -f docker-compose.yml up -d
      
      # Wait for services to be ready
      echo "Waiting for services to start..."
      sleep 30
      
      # Check container status
      echo "=== Container Status ==="
      docker-compose ps
      
      # Test connectivity using service names
      echo "=== Testing Internal Connectivity ==="
      
      # Test Prometheus via service name
      echo "Testing Prometheus at http://prometheus:9090..."
      if curl -s --connect-timeout 10 http://prometheus:9090/-/ready > /dev/null; then
        echo "✓ Prometheus is accessible via service name"
        # Get Prometheus status
        curl -s http://prometheus:9090/api/v1/status/config | jq '.status' || echo "Could not parse Prometheus response"
      else
        echo "✗ Cannot reach Prometheus via service name"
      fi
      
      # Test Grafana via service name
      echo "Testing Grafana at http://grafana:3000..."
      if curl -s --connect-timeout 10 http://grafana:3000/api/health > /dev/null; then
        echo "✓ Grafana is accessible via service name"
        # Get Grafana health status
        curl -s http://grafana:3000/api/health | jq '.' || echo "Could not parse Grafana response"
      else
        echo "✗ Cannot reach Grafana via service name"
      fi
      
      # Also test via localhost (port mapping)
      echo "=== Testing External Access ==="
      echo "Testing Prometheus at http://localhost:9090..."
      curl -s http://localhost:9090/-/ready > /dev/null && echo "✓ Prometheus accessible via localhost:9090" || echo "✗ Prometheus not accessible via localhost"
      
      echo "Testing Grafana at http://localhost:3000..."
      curl -s http://localhost:3000/api/health > /dev/null && echo "✓ Grafana accessible via localhost:3000" || echo "✗ Grafana not accessible via localhost"
      
      # Show network information
      echo "=== Network Information ==="
      echo "Docker networks:"
      docker network ls
      
      echo "Monitoring network details:"
      docker network inspect monitoring_monitoring || docker network inspect $(docker-compose ps -q | head -1 | xargs docker inspect --format='{{.NetworkSettings.Networks}}' | grep -o '\[[^]]*\]' | tr -d '[]') || echo "Could not inspect network"
      
      echo "=== Container IPs ==="
      echo "Prometheus container IP:"
      docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' prometheus
      
      echo "Grafana container IP:"
      docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' grafana
      
      echo "=== Service URLs ==="
      echo "Internal (container-to-container):"
      echo "  Prometheus: http://prometheus:9090"
      echo "  Grafana: http://grafana:3000"
      
      echo "External (from host/runner):"
      echo "  Prometheus: http://localhost:9090"
      echo "  Grafana: http://localhost:3000"
      
      # Keep running for testing
      echo "Monitoring stack is running. Containers will stay up for 10 minutes..."
      sleep 600
  when: manual
  allow_failure: true
  timeout: 1 hour

deploy-job:
  stage: deploy
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
