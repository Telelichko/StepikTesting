image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - report
  - monitor
  - deploy

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."

dotnet-test:
  stage: test
  services:
    - name: selenium/standalone-chrome:latest
      alias: selenium-standalone
  script:
    - dotnet restore
    - dotnet test StepikTesting.sln --logger "trx" --results-directory TestResults
  artifacts:
    when: always
    reports:
      junit:
        - TestResults/*.trx
    paths:
      - TestResults/
    expire_in: 1 week
  allow_failure: true

allure-report:
  image: openjdk:11-jdk
  stage: report
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
    - unzip allure-2.21.0.zip -d /opt/
    - ln -s /opt/allure-2.21.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate TestResults --clean -o allure-report
    - |
      # Create Allure properties to configure screenshot display
      mkdir -p allure-report/data
      cat > allure-report/data/environment.json << EOF
      {
        "allure": {
          "directory": "allure-results",
          "links": [],
          "environment": {
            "runtime": "net8.0",
            "allure_version": "2.21.0",
            "specflow_version": "3.9.74"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  dependencies:
    - dotnet-test

grafana-monitor:
  stage: monitor
  image: grafana/grafana:latest
  variables:
    GF_SECURITY_ADMIN_PASSWORD: "admin"
    GF_SECURITY_ADMIN_USER: "admin"
  before_script:
    - |
      mkdir -p /etc/prometheus
      cat > /etc/prometheus/prometheus.yml << EOF
      global:
        scrape_interval: 15s
        evaluation_interval: 15s

      scrape_configs:
        - job_name: 'gitlab-ci-pipelines-exporter'
          static_configs:
            - targets: ['gitlab-ci-exporter:8080']
          metrics_path: /metrics
          scrape_interval: 15s

        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']
      EOF

    - |
      mkdir -p /etc/grafana/provisioning/datasources
      cat > /etc/grafana/provisioning/datasources/prometheus.yml << EOF
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://localhost:9090
        access: proxy
        isDefault: true
        jsonData:
          httpMethod: POST
          timeInterval: 15s
          queryTimeout: 60s
      EOF

    - |
      mkdir -p /var/lib/grafana/dashboards
      cat > /var/lib/grafana/dashboards/gitlab-ci.json << EOF
      {
        "dashboard": {
          "id": null,
          "title": "GitLab CI Pipeline Metrics",
          "tags": ["gitlab", "ci"],
          "timezone": "browser",
          "panels": [],
          "time": {
            "from": "now-1h",
            "to": "now"
          }
        }
      }
      EOF

  script:
    - |
      echo "=== Monitoring Dashboard ==="
      echo "Grafana URL: http://localhost:3000"
      echo "Username: admin"
      echo "Password: admin"
      echo ""
      echo "Prometheus URL: http://localhost:9090"
      echo "GitLab Exporter: http://localhost:8080/metrics"
      echo ""
      echo "Data sources are auto-configured"
      /run.sh
  services:
    - name: prom/prometheus:latest
      alias: prometheus
      command: 
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--web.enable-remote-write-receiver'
        - '--web.cors.origin=.*'
    - name: mvisonneau/gitlab-ci-pipelines-exporter:latest
      alias: gitlab-ci-exporter
      variables:
        GITLAB_URL: "https://gitlab.com"
        GITLAB_TOKEN: "$CI_JOB_TOKEN"
        GCPE_WEB_SERVER_METRICS_ADDRESS: "0.0.0.0:8080"
  when: manual
  
start-exporter:
  stage: monitor
  image: alpine:latest
  services:
    - name: mvisonneau/gitlab-ci-pipelines-exporter:latest
      alias: gitlab-ci-exporter
  script:
    - echo "Exporter service is running alongside"

deploy-job:
  stage: deploy
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."