image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - report
  - monitoring
  - deploy

services:
  - name: selenium/standalone-chrome:latest
    alias: selenium-standalone

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."

dotnet-test:
  stage: test
  script:
    - dotnet restore
    - dotnet test StepikTesting.sln --logger "trx" --results-directory TestResults
  artifacts:
    when: always
    reports:
      junit:
        - TestResults/*.trx
    paths:
      - TestResults/
    expire_in: 1 week
  allow_failure: true

allure-report:
  image: openjdk:11-jdk
  stage: report
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
    - unzip allure-2.21.0.zip -d /opt/
    - ln -s /opt/allure-2.21.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate TestResults --clean -o allure-report
    - |
      mkdir -p allure-report/data
      cat > allure-report/data/environment.json << EOF
      {
        "allure": {
          "directory": "allure-results",
          "links": [],
          "environment": {
            "runtime": "net8.0",
            "allure_version": "2.21.0",
            "specflow_version": "3.9.74"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  dependencies:
    - dotnet-test

monitoring:
  image: docker:latest
  stage: monitoring
  services:
    - docker:dind
  before_script:
    - apk add --no-cache docker-compose curl jq
  script:
    # Create necessary directories
    - mkdir -p prometheus-storage
    - mkdir -p grafana-storage/provisioning/datasources
    - mkdir -p grafana-storage/provisioning/dashboards

    # Create Prometheus configuration
    - |
      cat > prometheus-storage/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: /metrics
    scheme: http

  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: /metrics
    scheme: http
EOF

    # Create Grafana datasource configuration
    - |
      cat > grafana-storage/provisioning/datasources/datasource.yml << 'EOF'
apiVersion: 1

datasources:
  - name: 'Prometheus'
    type: 'prometheus'
    access: 'proxy'
    url: 'http://prometheus:9090'
    isDefault: true
EOF

    # Create Grafana dashboard configuration
    - |
      cat > grafana-storage/provisioning/dashboards/dashboard.yml << 'EOF'
apiVersion: 1

providers:
  - name: 'default'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /etc/grafana/provisioning/dashboards
EOF

    # Stop any existing containers
    - echo "=== Cleaning up existing containers ==="
    - docker-compose -f docker-compose.yml down || true

    # Start monitoring stack
    - echo "=== Starting monitoring stack ==="
    - docker-compose -f docker-compose.yml up -d

    # Wait for services to initialize
    - echo "=== Waiting for services to start ==="
    - sleep 20

    # Check container status
    - echo "=== Container Status ==="
    - docker-compose ps

    # Check container logs
    - echo "=== Container Logs ==="
    - docker logs prometheus --tail 5 || echo "No Prometheus logs available"
    - docker logs grafana --tail 5 || echo "No Grafana logs available"

    # Test internal container health
    - echo "=== Testing Internal Container Health ==="
    - |
      if docker ps | grep -q prometheus; then
        echo "‚úÖ Prometheus container is running"
        if docker exec prometheus wget -q -O- http://localhost:9090/-/ready > /dev/null; then
          echo "‚úÖ Prometheus is healthy internally"
          echo "Prometheus config:"
          docker exec prometheus cat /etc/prometheus/prometheus.yml | head -10
        else
          echo "‚ùå Prometheus internal health check failed"
        fi
      else
        echo "‚ùå Prometheus container is not running"
      fi

    - |
      if docker ps | grep -q grafana; then
        echo "‚úÖ Grafana container is running"
        if docker exec grafana curl -s http://localhost:3000/api/health > /dev/null; then
          echo "‚úÖ Grafana is healthy internally"
          echo "Grafana datasources:"
          docker exec grafana cat /etc/grafana/provisioning/datasources/datasource.yml | head -10
        else
          echo "‚ùå Grafana internal health check failed"
        fi
      else
        echo "‚ùå Grafana container is not running"
      fi

    # Test inter-container communication
    - echo "=== Testing Container-to-Container Communication ==="
    - |
      if docker ps | grep -q prometheus && docker ps | grep -q grafana; then
        if docker exec grafana curl -s --connect-timeout 10 http://prometheus:9090/-/ready > /dev/null; then
          echo "‚úÖ Grafana can reach Prometheus via service name"
        else
          echo "‚ùå Grafana cannot reach Prometheus via service name"
        fi
      fi

    # Get container network information
    - echo "=== Container Network Information ==="
    - |
      PROMETHEUS_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' prometheus 2>/dev/null || echo "not-available")
      GRAFANA_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' grafana 2>/dev/null || echo "not-available")
      
      echo "Prometheus Container IP: $PROMETHEUS_IP"
      echo "Grafana Container IP: $GRAFANA_IP"
      echo ""
      echo "Network Details:"
      docker network ls | grep monitoring || echo "No monitoring network found"

    # Test monitoring functionality
    - echo "=== Testing Monitoring Functionality ==="
    - |
      if docker ps | grep -q prometheus; then
        echo "Testing Prometheus metrics..."
        docker exec prometheus curl -s http://localhost:9090/api/v1/query?query=up 2>/dev/null | \
          jq -r '.data.result[]? | "\(.metric.job): \(.value[1])"' 2>/dev/null || \
          echo "No metrics data available yet"
      fi

    # Final status report
    - echo "=== Final Monitoring Stack Status ==="
    - docker-compose ps
    - echo ""
    - echo "=== Summary ==="
    - echo "‚úÖ Monitoring stack deployment completed"
    - echo "üìä Services are running internally in Docker network"
    - echo "üîó Containers can communicate via service names"
    - echo "‚è±Ô∏è  Stack will remain active for 5 minutes"
    - echo ""
    - echo "Note: External access is restricted in GitLab Runner environment."
    - echo "This setup verifies container networking and service integration."

    # Keep containers running for testing
    - echo "=== Keeping containers running ==="
    - sleep 300

    # Cleanup
    - echo "=== Cleaning up ==="
    - docker-compose -f docker-compose.yml down
    - echo "Monitoring stack stopped"
  when: manual
  allow_failure: true
  timeout: 30 minutes

deploy-job:
  stage: deploy
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
