image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - report
  - monitoring
  - deploy

services:
  - name: selenium/standalone-chrome:latest
    alias: selenium-standalone

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."

dotnet-test:
  stage: test
  script:
    - dotnet restore
    - dotnet test StepikTesting.sln --logger "trx" --results-directory TestResults
  artifacts:
    when: always
    reports:
      junit:
        - TestResults/*.trx
    paths:
      - TestResults/
    expire_in: 1 week
  allow_failure: true

allure-report:
  image: openjdk:11-jdk
  stage: report
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.21.0/allure-2.21.0.zip
    - unzip allure-2.21.0.zip -d /opt/
    - ln -s /opt/allure-2.21.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate TestResults --clean -o allure-report
    - |
      mkdir -p allure-report/data
      cat > allure-report/data/environment.json << EOF
      {
        "allure": {
          "directory": "allure-results",
          "links": [],
          "environment": {
            "runtime": "net8.0",
            "allure_version": "2.21.0",
            "specflow_version": "3.9.74"
          }
        }
      }
      EOF
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  dependencies:
    - dotnet-test

grafana-monitoring:
  stage: monitoring
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache docker-compose curl
  script:
    # Create minimal configuration directories
    - mkdir -p prometheus-storage
    - mkdir -p grafana-storage/provisioning/datasources

    # Create basic Prometheus config using echo
    - echo "Creating Prometheus configuration..."
    - echo "global:" > prometheus-storage/prometheus.yml
    - echo "  scrape_interval: 15s" >> prometheus-storage/prometheus.yml
    - echo "" >> prometheus-storage/prometheus.yml
    - echo "scrape_configs:" >> prometheus-storage/prometheus.yml
    - echo "  - job_name: 'prometheus'" >> prometheus-storage/prometheus.yml
    - echo "    static_configs:" >> prometheus-storage/prometheus.yml
    - echo "      - targets: ['localhost:9090']" >> prometheus-storage/prometheus.yml

    # Create basic Grafana datasource config using echo
    - echo "Creating Grafana datasource configuration..."
    - echo "apiVersion: 1" > grafana-storage/provisioning/datasources/datasource.yml
    - echo "" >> grafana-storage/provisioning/datasources/datasource.yml
    - echo "datasources:" >> grafana-storage/provisioning/datasources/datasource.yml
    - echo "  - name: 'Prometheus'" >> grafana-storage/provisioning/datasources/datasource.yml
    - echo "    type: 'prometheus'" >> grafana-storage/provisioning/datasources/datasource.yml
    - echo "    access: 'proxy'" >> grafana-storage/provisioning/datasources/datasource.yml
    - echo "    url: 'http://prometheus:9090'" >> grafana-storage/provisioning/datasources/datasource.yml
    - echo "    isDefault: true" >> grafana-storage/provisioning/datasources/datasource.yml

    # Start services
    - echo "Starting monitoring stack..."
    - docker-compose -f docker-compose.yml up -d

    # Wait for services to start
    - echo "Waiting for services to be ready..."
    - sleep 30

    # Check if containers are running
    - echo "=== Container Status ==="
    - docker-compose ps

    # Test basic connectivity
    - echo "=== Testing Basic Connectivity ==="

    # Test Prometheus from inside its container
    - echo "Testing Prometheus internally..."
    - docker exec prometheus wget -q -O- http://localhost:9090/-/ready && echo "✅ Prometheus is ready" || echo "❌ Prometheus not ready"

    # Test Grafana from inside its container
    - echo "Testing Grafana internally..."
    - docker exec grafana curl -s -f http://localhost:3000/api/health && echo "✅ Grafana is healthy" || echo "❌ Grafana not healthy"

    # Test if Grafana can reach Prometheus
    - echo "Testing Grafana -> Prometheus connection..."
    - docker exec grafana curl -s http://prometheus:9090/-/ready && echo "✅ Grafana can reach Prometheus" || echo "❌ Grafana cannot reach Prometheus"

    # Get container information
    - echo "=== Container Information ==="
    - echo "Prometheus container IP: $(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' prometheus)"
    - echo "Grafana container IP: $(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' grafana)"

    # Show service URLs
    - echo "=== Service URLs ==="
    - echo "Prometheus: http://localhost:9090 (from GitLab runner)"
    - echo "Grafana: http://localhost:3000 (from GitLab runner)"
    - echo "Grafana credentials: admin/admin"

    # Test external access
    - echo "=== Testing External Access ==="
    - curl -s --connect-timeout 10 http://localhost:9090 > /dev/null && echo "✅ Prometheus accessible via localhost" || echo "❌ Prometheus not accessible via localhost"
    - curl -s --connect-timeout 10 http://localhost:3000 > /dev/null && echo "✅ Grafana accessible via localhost" || echo "❌ Grafana not accessible via localhost"

    # Keep services running for a while
    - echo "Monitoring stack is running. Will keep active for 2 minutes..."
    - sleep 120

    # Cleanup
    - echo "Stopping monitoring stack..."
    - docker-compose down
  when: manual
  allow_failure: true
  timeout: 20 minutes

deploy-job:
  stage: deploy
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
